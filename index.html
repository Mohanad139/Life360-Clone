<!DOCTYPE html>
<html>
<head>
    <title>Life360 Clone</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">  
     <!-- Leaflet CSS will go here -->
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     <!-- Leaflet  will go here -->
     <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
</head>
<body>
    <h1></h1>
    
    <!-- Map will go here -->
    <div id="map" style="height: 1000px; width: 100%; display: none;"></div>
    
    <script>
        let map;
        function initializeMap() {
            map = L.map('map').setView([43.4643, -80.5204], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            return map;
        }

        let markers = [];  // Global array to store markers

        function loadUserLocations() {
            // Clear old markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            fetch('http://127.0.0.1:5000/locations')
                .then(response => response.json())
                .then(data => {
                    const bounds = [];
                        
                    for (let username in data.Users) {
                        let lat = data.Users[username].Latitude;
                        let lon = data.Users[username].Longitude;
                        
                        const marker = L.marker([lat, lon]).addTo(map)
                        .bindPopup(username);
                        
                        markers.push(marker);  // Save marker
                        bounds.push([lat, lon]);}
                    
                    if (bounds.length > 0) {
                        map.fitBounds(L.latLngBounds(bounds), { padding: [50, 50] });
                    }
                });
        }
        


    </script>

    

    


    <!-- Form will go here -->
     <div class="login">
        <form>
            <h1>Welcome!</h1>
            <div class="input-box">
                <input type="text" id="login-username" placeholder="Username"
                required>
                <i class='bx  bx-user'></i> 
            </div>
            <div class="input-box">
                <input type="password" id="login-password" placeholder="Password"
                required>
                <i class='bx  bx-lock'></i> 
            </div>


            <button type="submit" class="btn" >Login</button> 


            <div class="auth-links">
            <a href="#" onclick=showRegister()>Sign Up</a>
            <span class="divider">|</span>
            <a href="/forgot-password">Forgot password?</a>
            </div>


            
        </form>

     </div>

          <div class="Register-form">
        <form>
            <h1>Register</h1>
            <div class="input-box">
                <input type="text" id="register-username" placeholder="Username"
                required>
                 <i class='bx  bx-user'></i> 

            </div>
            <div class="input-box">
                <input type="password" id="register-password"placeholder="Password"
                required>
                 <i class='bx  bx-lock'></i> 

            </div>

            

            <button type="submit" class="btn" >Register</button> 

            <div class="login-url">
                <p>Already have an account? <a href="#" onclick=showLogin() >Login</a></p>
            </div>


        </form>
     </div>

     <div class="Share">
        <button id="share-location-btn" onclick="shareLocation()">Share My Location </button>
    </div>

    <script>
        // Show register form, hide login form
        function showRegister() {
            document.querySelector('.login').style.display = 'none';
            document.querySelector('.Register-form').style.display = 'block';
        }

        // Show login form, hide register form
        function showLogin() {
            document.querySelector('.login').style.display = 'block';
            document.querySelector('.Register-form').style.display = 'none';
        }
    </script>

     <script>
        document.querySelector('.Register-form form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get values from form
            const username = document.getElementById("register-username").value;
            const password = document.getElementById("register-password").value;
            
            // Create form data
            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);
            
            // Send to backend
            const url = 'http://127.0.0.1:5000/register';
            fetch(url, {
                method: "POST",
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Problem with the network");
                }
                return response.json();
            })
            .then(data => {
                console.log('Success:', data);
                alert('Registration successful!');  // Show message to user
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Registration failed!');  // Show error to user
            });
        });
     </script>

     <script>
        document.querySelector('.login form').addEventListener('submit', async function(e) {
            e.preventDefault();
        
        const username = document.getElementById("login-username").value;
        const password = document.getElementById("login-password").value;

        const formData = new FormData();
        formData.append("username",username);
        formData.append("password",password);

        const url = 'http://127.0.0.1:5000/login';
        fetch(url,{
            method : "POST",
            body : formData
        })
        .then(response =>{
            if(!response.ok) {
                throw new Error("Problem with the network")
            }
            return response.json()
        })
        .then(data =>{
            localStorage.setItem("token", data.token);
            document.querySelector('.login').style.display = 'none';
            document.body.style.background = 'white';  // Remove background image
            document.getElementById("map").style.display = "block";
            
            initializeMap();
            loadUserLocations();
            setInterval(function() {

                loadUserLocations();
            }, 30000);  // 30000 milliseconds = 30 seconds
                    
        })
        .catch(error =>{
            console.error("error",error)
        })
        });

     </script>

    
    
    <!-- Users list will go here -->
    <div id="users"></div>

    <script>
        function shareLocation() {
        const token = localStorage.getItem('token');
        
        if (!token) {
            alert('Please login first');
            return;
        }
        
        // Get user's GPS location from browser
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                fetch(`http://127.0.0.1:5000/update_location/${lat}/${lon}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Fetched Data:", data);
                    alert('Successfully sent')
                })
                .catch(error => {
                    console.error("Error", error);
                    alert('Could not send the location')
                });
            },
            function(error) {
                alert('Could not get your location');
            }
        );
    }
    </script>
</body>
</html>